---
layout: post
title: "Mysql"
date: 2018-12-03 
categories: mysql
---
## Index 索引
Primary key,unique,index and fulltext索引的底层数据结构都是B-trees.
多列索引（组合索引）。遵从最左原则。
### InnoDB
一种在高可用、高性能之间平衡性的引擎。从版本8.0开始，InnoDB已经作为Mysql的默认存储引擎。
#### 优点
- 在ACID（Atomicity,Consistency,Isolation,Durability）模型下的DML操作，加上事务的提交，回滚和灾难恢复等特性，可以很好地保护用户数据。
- 行级别的锁机制和一致性读增加多用户并发和性能
- clustered index 优化磁盘查找
- 支持foreign key约束
### mysql explain

[office documentation](https://dev.mysql.com/doc/refman/8.0/en/explain-output.html)
```
explain query SQL; 
```

| id | select_type | table       | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra |
|----|-------------|-------------|------------|------|---------------|------|---------|------|------|----------|-------|
|  1 | SIMPLE      | table_name  | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    1 |   100.00 | NULL  |

EXPLAIN output column 

| Column | JSON Name | Meaning |
|---|----|-----|
|id|  select_id   |The SELECT identifier|
|select_type |None   | The SELECT type|
|table  | table_name  |The table for the output row|
|partitions  |partitions  |The matching partitions|
|type    |access_type |The join type|
|possible_keys   |possible_keys   |The possible indexes to choose|
|key |key |The index actually chosen|
|key_len |key_length  |The length of the chosen key|
|ref |ref |The columns compared to the index|
|rows    |rows    |Estimate of rows to be examined|
|filtered    |filtered    |Percentage of rows filtered by table condition|
|Extra   |None    |Additional information|

### 事务

事务隔离级别
1. **读未提交** SET @@session.transaction_isolation =  'READ-UNCOMMITTED';
    该隔离级别的事务会读到其它未提交事务的数据，此现象也称之为**脏读**。但是该事务隔离级别的并发是最好的。
1. **读提交** 'READ-COMMITTED'，一个事务可以读取另一个已提交事务，多次读取会造成不告诉的结果，此现象称为**不可重复读问题**。
1. **可重复读** 'REPEATABLE READ'，为Mysql默认的隔离级别，在同一个事务里，select的结果是事务开始时间点的状态，因此，同样的select 操作读到的结果会是一致的，但是，会有**幻读**现象。
1. **序列化** 'SERIALIZABLE'，在该隔离级别下事务都是串行顺序执行的，Mysql数据库的InnoDB引擎会给读操作隐式加一把读共享锁，避免脏读、不可重复读和幻读问题。



### mysql [locking reads](https://dev.mysql.com/doc/refman/8.0/en/innodb-locking-reads.html)
```
SELECT ... FOR SHARE
SELECT ... FOR UPDATE
```

### 锁
操作系统层面有共享读锁、排它写锁。
共享读锁，就是一个资源，可以同时供多个进程读，但不允许写。
排它写锁，不允许其它进程读或者写。

Mysql又提供了哪些锁呢？

#### 表锁
```
LOCK TABLES table_name [READ | WRITE]
```
InnoDB 引擎 锁和事务模型
提供两种行级别锁，共享和排它锁。
如果事务T1对表里的记录row有共享锁，则其它事务T2可以对该记录加共享锁，此时T1和T2都对row拥有共享锁；其它事务不能对row加排它锁。
如果事务T1对表里的记录row有排它锁，则其它事务T2即不能对row加共享锁或排它锁，只能等待T1的锁释放

### 死锁
死锁指两个或两个以上的进程在执行过程中，由于竞争资源或者由于彼此通信而造成的一种阻塞的现象，若无外力作用，它们都将无法推进下去。


## 主从复制

master将所有改变数据的事件记录至binary log中。
slave连接至master之后，会pull master的binary log至本地，然后执行其中的事件。

实现细节。有3个线程来复制主从复制。
master binlog dump thread
slave I/O thread get master's binary log and save that as local relay log
slave SQL thred execute the relay log event