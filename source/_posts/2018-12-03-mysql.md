---
layout: post
title: "Mysql"
date: 2018-12-03 
categories: mysql
---
## Index 索引
Primary key,unique,index and fulltext索引的底层数据结构都是B-trees.
多列索引（组合索引）。遵从最左原则。
### InnoDB
一种在高可用、高性能之间平衡性的引擎。从版本8.0开始，InnoDB已经作为Mysql的默认存储引擎。
#### 优点
- 在ACID（Atomicity,Consistency,Isolation,Durability）模型下的DML操作，加上事务的提交，回滚和灾难恢复等特性，可以很好地保护用户数据。
- 行级别的锁机制和一致性读增加多用户并发和性能
- clustered index 优化磁盘查找
- 支持foreign key约束
### mysql explain

[office documentation](https://dev.mysql.com/doc/refman/8.0/en/explain-output.html)
```
explain query SQL; 
```

| id | select_type | table       | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra |
|----|-------------|-------------|------------|------|---------------|------|---------|------|------|----------|-------|
|  1 | SIMPLE      | table_name  | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    1 |   100.00 | NULL  |

EXPLAIN output column 

| Column | JSON Name | Meaning |
|---|----|-----|
|id|  select_id   |The SELECT identifier|
|select_type |None   | The SELECT type|
|table  | table_name  |The table for the output row|
|partitions  |partitions  |The matching partitions|
|type    |access_type |The join type|
|possible_keys   |possible_keys   |The possible indexes to choose|
|key |key |The index actually chosen|
|key_len |key_length  |The length of the chosen key|
|ref |ref |The columns compared to the index|
|rows    |rows    |Estimate of rows to be examined|
|filtered    |filtered    |Percentage of rows filtered by table condition|
|Extra   |None    |Additional information|

### 事务


### mysql [locking reads](https://dev.mysql.com/doc/refman/8.0/en/innodb-locking-reads.html)
```
SELECT ... FOR SHARE
SELECT ... FOR UPDATE
```

### 锁
操作系统层面有共享读锁、排它写锁。
共享读锁，就是一个资源，可以同时供多个进程读，但不允许写。
排它写锁，不允许其它进程读或者写。

Mysql又提供了哪些锁呢？

#### 表锁
```
LOCK TABLES table_name [READ | WRITE]
```
InnoDB 引擎 锁和事务模型
提供两种行级别锁，共享和排它锁。
如果事务T1对表里的记录row有共享锁，则其它事务T2可以对该记录加共享锁，此时T1和T2都对row拥有共享锁；其它事务不能对row加排它锁。
如果事务T1对表里的记录row有排它锁，则其它事务T2即不能对row加共享锁或排它锁，只能等待T1的锁释放


## 主从复制

master将所有改变数据的事件记录至binary log中。
slave连接至master之后，会pull master的binary log至本地，然后执行其中的事件。

实现细节。有3个线程来复制主从复制。
master binlog dump thread
slave I/O thread get master's binary log and save that as local relay log
slave SQL thred execute the relay log event